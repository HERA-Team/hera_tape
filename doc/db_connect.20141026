Feature Request:

    Reconnect to database before making update to data following connection timeout



Error: 

After dumping all the data to tape (>3000 minutes) the mysql connection had gone away.

Traceback (most recent call last):
  File "test-paper-dump.py", line 4, in <module>
    x.archive_to_tape()
  File "/root/git/papertape/bin/paper_dump.py", line 55, in archive_to_tape
    self.files.gen_final_catalog(self.files.catalog_name,  cumulative_catalog)
  File "/root/git/papertape/bin/paper_io.py", line 45, in gen_final_catalog
    cfile.write('%s:%s:%s\n' % (file[0], int, file[1]))
TypeError: 'int' object is not subscriptable
Exception ignored in: <bound method mtxdb.__del__ of <paper_mtx.mtxdb object at 0x2b78f7d345f8>>
Traceback (most recent call last):
  File "/root/git/papertape/bin/paper_mtx.py", line 189, in __del__
    self.connect.commit()
  File "/root/.pyenv/versions/3.4.1/lib/python3.4/site-packages/pymysql/connections.py", line 673, in commit
    self._execute_command(COM_QUERY, "COMMIT")
  File "/root/.pyenv/versions/3.4.1/lib/python3.4/site-packages/pymysql/connections.py", line 888, in _execute_command
    self._write_bytes(prelude + sql[:chunk_size-1])
  File "/root/.pyenv/versions/3.4.1/lib/python3.4/site-packages/pymysql/connections.py", line 848, in _write_bytes
    raise OperationalError(2006, "MySQL server has gone away (%r)" % (e,))
pymysql.err.OperationalError: (2006, "MySQL server has gone away (BrokenPipeError(32, 'Broken pipe'))")



Bug:

  The mysql connection timeout was reached before the script tried updating the db. 



Fix:

    2. variable containing the database timeout
    1. variable containing the timestamp from when the connection was last used
    2. a function to compare the timestamp to the current time
    3. a function to reconnect to database if timeout is exceeded


Refactor (optional):

  [ code we change along the way to make it better or easier to understand (not the actual fix) ]

 

Test:

  [ description of how to test code with expected results ]
  [ optionally, include example test scripts of code ]



Owner: dconover:20141026
Review: [username]:[date]

